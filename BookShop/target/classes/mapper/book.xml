<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="book">
	
	<sql id="search">
		select * from book
		<where>
			<if test="search == 1 and keyword.trim() != ''">
				bookId LIKE CONCAT(CONCAT('%',#{keyword}),'%')
			</if>
			<if test="search == 2 and keyword.trim() != ''">
				bookName LIKE CONCAT(CONCAT('%',#{keyword}),'%')
			</if>
			<if test="search == 3 and keyword.trim() != ''">
				publisher LIKE CONCAT(CONCAT('%',#{keyword}),'%')
			</if>
		</where>
	</sql>
	
    <select id="list" resultType="Book">
        select t.*
			from
			    (select t1.*
			            ,rownum rnum
			        from(<include refid="search"></include>)t1) t
		    	<if test="perPage != 0">
		     		where t.rnum between ((#{page}-1) * #{perPage})+1  and ( #{page} * #{perPage} )
		     	</if>
    </select>
    <select id="total" resultType="Integer">
        select count(*) from (<include refid="search"></include>)   
    </select>
    
    <select id="getBook" resultType="Book">
        SELECT * FROM book
        where bookId = #{bookId}
    </select>
   
    <insert id="addBook">
        INSERT INTO book (bookId
							,bookName
							,publisher
							,bookPrice
							,pubdate)
        VALUES (BOOK_SEQ.nextval, #{bookName}, #{publisher},#{bookPrice}, TO_DATE(#{pubDate},'yyyy/MM/dd'))
       	<selectKey keyProperty="bookId" resultType="int" order="AFTER">
	    	SELECT BOOK_SEQ.currval FROM DUAL
		</selectKey>
    </insert>
    <!--
    	transaction으로 현재 등록 정보는 그 정보의 현재 번호를 가지게됨
    	egov에서는 백엔드에서 아이디젠을 사용하지만 결국 거기서도 시퀀스를 사용한 값을 사용하기 때문에 비효율 적이다.
    	 
     -->
    
    <insert id="fileupload" parameterType="Fileupload">
        INSERT INTO fileupload (code, fileName, bookId)
        values (FILEUPLOAD_SEQ.nextval, #{fileName}, #{bookId})
    </insert>
    
    <update id="updateBook" parameterType="Book">
        UPDATE book
    	 SET 
    	 	bookName = #{bookName}
			,publisher = #{publisher}
			,bookPrice = #{bookPrice}
			,pubdate = TO_DATE(#{pubDate},'yyyy/MM/dd')
        WHERE bookId = #{bookId}
    </update>
    
    <delete id="deleteBook" parameterType="Integer">
        DELETE FROM book
        WHERE bookId = #{bookId}
    </delete> 
	
</mapper>